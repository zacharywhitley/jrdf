<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd">

    <!-- Beans for constant values -->
    <bean id="org.restlet.data.MediaType.TEXT_HTML"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"/>

    <bean id="org.restlet.data.MediaType.APPLICATION_JSON"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"/>

    <bean id="org.jrdf.restlet.MediaTypeExtensions.APPLICATION_SPARQL"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"/>

    <bean id="org.restlet.data.MediaType.APPLICATION_XML"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"/>

    <bean id="org.restlet.Redirector.MODE_CLIENT_PERMANENT"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean"/>

    <!-- Properties -->
    <bean id="configurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>classpath:org/jrdf/restlet/server/local/server.properties</value>
            </list>
        </property>
        <property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE"/>
    </bean>

    <!-- Context for non-Springifed Restlet -->
    <bean id="component.context" class="org.springframework.beans.factory.config.PropertyPathFactoryBean"/>
    <bean id="component.childContext" scope="prototype" factory-bean="component.context" factory-method="createChildContext"/>

    <!-- Main web application -->
    <bean id="directoryHandler" class="org.jrdf.util.TempDirectoryHandler">
        <constructor-arg value="${persistent.directory}"/>
    </bean>

    <bean id="component" class="org.restlet.ext.spring.SpringComponent">
        <property name="server" ref="server"/>
        <property name="defaultTarget" ref="router"/>
        <property name="logService" ref="logService"/>
    </bean>

    <bean id="server" class="org.restlet.ext.spring.SpringServer">
        <constructor-arg value="http"/>
        <constructor-arg value="${server.port}"/>
    </bean>

    <bean id="logService" class="org.restlet.service.LogService">
        <constructor-arg value="true"/>
    </bean>

    <!-- Freemarker -->
    <bean id="freemarkerConfig" class="freemarker.template.Configuration">
        <property name="directoryForTemplateLoading" value="${user.dir}/resources"/>
        <property name="objectWrapper">
            <bean class="freemarker.template.DefaultObjectWrapper"/>
        </property>
    </bean>

    <!-- Router for Resources -->
    <bean id="router" class="org.restlet.ext.spring.SpringRouter">
        <property name="attachments">
            <map>
                <entry key="" value-ref="redirector">
                </entry>
                <entry key="/graphs">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="graphs"/>
                    </bean>
                </entry>
                <entry key="/graphs/{graph}">
                    <bean class="org.restlet.ext.spring.SpringFinder">
                        <lookup-method name="createResource" bean="localGraphResource"/>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <!-- Redirector -->
    <bean id="redirector" class="org.restlet.Redirector">
        <constructor-arg ref="component.childContext"/>
        <constructor-arg value="/graphs"/>
        <constructor-arg ref="org.restlet.Redirector.MODE_CLIENT_PERMANENT"/>
    </bean>

    <!-- List the graphs -->
    <bean id="graphs" class="org.jrdf.restlet.server.GraphsResource" scope="prototype">
        <property name="graphLister" ref="graphListImpl"/>
        <property name="available" value="true"/>
        <property name="representationTemplates">
            <map>
                <entry key-ref="org.restlet.data.MediaType.TEXT_HTML" value-ref="graphsResourceHtml"/>
                <entry key-ref="org.restlet.data.MediaType.APPLICATION_JSON" value-ref="jsonRepresentationFactory"/>
            </map>
        </property>
    </bean>

    <bean id="graphsResourceHtml" class="org.jrdf.restlet.FreemarkerRepresentationFactory">
        <property name="templateName" value="graphsPage.ftl"/>
        <property name="freemarkerConfig" ref="freemarkerConfig"/>
    </bean>

    <bean id="graphListImpl" class="org.jrdf.restlet.server.GraphListerImpl" scope="prototype">
        <constructor-arg ref="directoryHandler"/>
        <constructor-arg ref="webApplication"/>
        <constructor-arg value="${graphs.file}"/>
    </bean>

    <!-- Do SPARQL queries -->
    <bean id="queryFactory" class="org.jrdf.query.QueryFactoryImpl"/>
    <bean id="queryBuilder" factory-bean="queryFactory" factory-method="createQueryBuilder" scope="prototype"/>
    <bean id="queryEngine" factory-bean="queryFactory" factory-method="createQueryEngine" scope="prototype"/>

    <bean id="urqlConnection" class="org.jrdf.urql.UrqlConnectionImpl" scope="prototype">
        <constructor-arg ref="queryBuilder"/>
        <constructor-arg ref="queryEngine"/>
    </bean>

    <bean id="webApplication" class="org.jrdf.restlet.server.local.GraphApplicationImpl">
        <constructor-arg ref="directoryHandler"/>
        <constructor-arg ref="urqlConnection"/>
    </bean>
    <bean id="localGraphResource" class="org.jrdf.restlet.server.local.LocalGraphResource" scope="prototype">
        <property name="graphApplication" ref="webApplication"/>
    </bean>

    <bean id="jsonRepresentationFactory" class="org.jrdf.restlet.server.JsonRepresentationFactory"/>
</beans>